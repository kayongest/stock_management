<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>:: aB</title>
    <link rel="shortcut icon" href="../assets/img/app-store.png" />
    <meta
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
      name="viewport"
    />

    <meta name="description" content="Event Management Platform" />
    <meta name="author" content="Kayonga Raul" />

    <!-- Vendor CSS -->
    <link href="../assets/css/vendor.min.css" rel="stylesheet" />
    <link href="../assets/css/default/app.min.css" rel="stylesheet" />

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- DataTables CSS -->
    <link
      href="../assets/plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="../assets/plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      /* Google Fonts  */
      @import url("https://fonts.googleapis.com/css2?family=Titillium+Web:wght@200;300;400;600;700&display=swap");
      * {
        font-family: "Titillium Web", sans-serif;
      }
      .app-header {
        background-color: #35374b;
      }

      /* Ensure no global styles are applied */
      body {
        filter: none !important;
        backdrop-filter: none !important;
      }
    </style>
  </head>

  <body>
    <div id="loader" class="app-loader">
      <span class="spinner"></span>
    </div>

    <div id="app" class="app app-header-fixed app-sidebar-fixed">
      <div id="header" class="app-header text-white">
        <div class="navbar-header">
          <a href="index.html" class="navbar-brand text-white">
            <b class="me-3px">[aB]</b>ility</a
          >
          <button
            type="button"
            class="navbar-mobile-toggler"
            data-toggle="app-sidebar-mobile"
          >
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <div class="navbar-nav">
          <div class="navbar-item dropdown">
            <a
              href="#"
              data-bs-toggle="dropdown"
              class="navbar-link dropdown-toggle icon"
            >
              <i class="fa fa-bell text-white"></i>
              <span class="badge">5</span>
            </a>
            <div class="dropdown-menu media-list dropdown-menu-end">
              <div
                class="dropdown-header text-white"
                style="background-color: #044a42"
              >
                NOTIFICATIONS (5)
              </div>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <i class="fa fa-bug media-object bg-gray-500"></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">
                    Server Error Reports
                    <i class="fa fa-exclamation-circle text-danger"></i>
                  </h6>
                  <div class="text-muted fs-10px">3 minutes ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <img
                    src="../assets/img/user/user-1.jpg"
                    class="media-object"
                    alt
                  />
                  <i
                    class="fab fa-facebook-messenger text-blue media-object-icon"
                  ></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">John Smith</h6>
                  <p>
                    Quisque pulvinar tellus sit amet sem scelerisque tincidunt.
                  </p>
                  <div class="text-muted fs-10px">25 minutes ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <img
                    src="../assets/img/user/user-2.jpg"
                    class="media-object"
                    alt
                  />
                  <i
                    class="fab fa-facebook-messenger text-blue media-object-icon"
                  ></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">Olivia</h6>
                  <p>
                    Quisque pulvinar tellus sit amet sem scelerisque tincidunt.
                  </p>
                  <div class="text-muted fs-10px">35 minutes ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <i class="fa fa-plus media-object bg-gray-500"></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">New User Registered</h6>
                  <div class="text-muted fs-10px">1 hour ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <i class="fa fa-envelope media-object bg-gray-500"></i>
                  <i
                    class="fab fa-google text-warning media-object-icon fs-14px"
                  ></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">New Email From John</h6>
                  <div class="text-muted fs-10px">2 hour ago</div>
                </div>
              </a>
              <div class="dropdown-footer text-center">
                <a href="javascript:;" class="text-decoration-none"
                  >View more</a
                >
              </div>
            </div>
          </div>
          <div class="navbar-item navbar-user dropdown text-white">
            <a
              href="#"
              class="navbar-link dropdown-toggle d-flex align-items-center"
              data-bs-toggle="dropdown"
            >
              <img src="../assets/img/user/user-13.jpg" alt />
              <span>
                <span class="d-none d-md-inline text-white">Kayonga Raul</span>
                <!-- <b class="caret"></b> -->
              </span>
            </a>
            <div class="dropdown-menu dropdown-menu-end me-1">
              <a href="extra_profile.html" class="dropdown-item"
                >Edit Profile</a
              >
              <a
                href="email_inbox.html"
                class="dropdown-item d-flex align-items-center"
              >
                Inbox
                <span class="badge bg-danger rounded-pill ms-auto pb-4px"
                  >2</span
                >
              </a>
              <a href="calendar.html" class="dropdown-item">Calendar</a>
              <a href="extra_settings_page.html" class="dropdown-item"
                >Settings</a
              >
              <div class="dropdown-divider"></div>
              <a href="login.html" class="dropdown-item">Log Out</a>
            </div>
          </div>
        </div>
      </div>

      <div id="sidebar" class="app-sidebar" data-bs-theme="dark">
        <div
          class="app-sidebar-content"
          data-scrollbar="true"
          data-height="100%"
        >
          <div class="menu">
            <div class="menu-profile">
              <div class="menu-profile-cover with-shadow"></div>
              <div class="menu-profile-image">
                <img src="../assets/img/user/user-13.jpg" alt />
              </div>
              <div class="menu-profile-info">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">Kayonga Raul</div>
                  <!-- <div class="menu-caret ms-auto"></div> -->
                </div>
                <small>Administrator</small>
              </div>
            </div>
            <div class="menu-header">Navigation</div>
            <div class="menu-item active">
              <a href="table_manage_buttons.html" class="menu-link">
                <div class="menu-icon">
                  <i class="fa fa-boxes-packing"></i>
                </div>
                <div class="menu-text">Dashboard</div>
              </a>
            </div>
            <div class="menu-item">
              <a href="stocks.html" class="menu-link">
                <div class="menu-icon">
                  <i class="fa fa-warehouse"></i>
                </div>
                <div class="menu-text">Stocks</div>
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="app-sidebar-bg" data-bs-theme="dark"></div>
      <div class="app-sidebar-mobile-backdrop">
        <a
          href="#"
          data-dismiss="app-sidebar-mobile"
          class="stretched-link"
        ></a>
      </div>

      <div id="content" class="app-content">
        <h1 class="page-header">
          Dashboard <small>overall statistics ..</small>
        </h1>

        <div class="row">
          <div class="col-xl-12">
            <div class="panel panel-inverse">
              <div class="panel-heading">
                <h4 class="panel-title">ITEMS</h4>
                <div class="panel-heading-btn">
                  <a
                    href="javascript:;"
                    class="btn btn-xs btn-icon btn-success"
                    data-toggle="panel-reload"
                    ><i class="fa fa-redo"></i
                  ></a>
                  <a
                    href="javascript:;"
                    class="btn btn-xs btn-icon btn-warning"
                    data-toggle="panel-collapse"
                    ><i class="fa fa-minus"></i
                  ></a>
                </div>
              </div>

              <div class="panel-footer">
                <div class="container">
                  <div class="row">
                    <div class="col-sm-6">
                      <a
                        href="#modal-dialog"
                        class="btn btn-md me-1 text-white"
                        style="background-color: #0b6b94"
                        data-bs-toggle="modal"
                        data-bs-target="#itemModal"
                        >ADD</a
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal -->
              <div
                class="modal fade"
                id="itemModal"
                tabindex="-1"
                aria-labelledby="itemModalLabel"
                aria-hidden="true"
              >
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header" style="background-color: #20425f">
                      <h4 class="modal-title text-white" id="itemModalLabel">
                        ADD ITEM
                      </h4>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      ></button>
                    </div>
                    <div class="modal-body">
                      <form id="itemForm" enctype="multipart/form-data">
                        <!-- Hidden Input for Item ID -->
                        <input type="hidden" id="item_id" name="item_id" />

                        <!-- Grid System for Two Columns -->
                        <div class="row">
                          <!-- Column 1 -->
                          <div class="col-md-6">
                            <!-- Item Name -->
                            <div class="mb-3">
                              <label for="item_name" class="form-label"
                                >Item Name</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="item_name"
                                name="item_name"
                                required
                              />
                            </div>

                            <!-- Item Description -->
                            <div class="mb-3">
                              <label for="item_description" class="form-label"
                                >Item Description</label
                              >
                              <textarea
                                class="form-control"
                                id="item_description"
                                name="item_description"
                              ></textarea>
                            </div>

                            <!-- Item Category -->
                            <div class="mb-3">
                              <label for="item_category" class="form-label"
                                >Item Category</label
                              >
                              <select
                                class="form-select"
                                id="item_category"
                                name="item_category"
                                required
                              >
                                <option value="">-- select --</option>
                                <option value="VIDEO">VIDEO</option>
                                <option value="IT">IT</option>
                                <option value="SOUND">SOUND</option>
                                <option value="SIS">SIS</option>
                                <option value="LIGHTS">LIGHTS</option>
                                <option value="OTHER">OTHER</option>
                              </select>
                            </div>

                            <!-- Stock Location -->
                            <div class="mb-3">
                              <label for="stock_location" class="form-label"
                                >Stock Location</label
                              >
                              <select
                                class="form-select"
                                id="stock_location"
                                name="stock_location"
                                required
                              >
                                <option value="">-- select --</option>
                                <option value="Masoro">Masoro</option>
                                <option value="KCC">KCC</option>
                                <option value="BK Arena">BK Arena</option>
                                <option value="Ndera">Ndera</option>
                                <option value="Rugando">Rugando</option>
                              </select>
                            </div>

                            <!-- Serial Number -->
                            <div class="mb-3">
                              <label for="serial_number" class="form-label"
                                >Serial Number</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="serial_number"
                                name="serial_number"
                                required
                              />
                            </div>
                          </div>

                          <!-- Column 2 -->
                          <div class="col-md-6">
                            <!-- Item Status -->
                            <div class="mb-3">
                              <label for="item_status" class="form-label"
                                >Item Status</label
                              >
                              <select
                                class="form-select"
                                id="item_status"
                                name="item_status"
                                required
                              >
                                <option value="">-- select --</option>
                                <option value="New">New</option>
                                <option value="Working">Working</option>
                                <option value="Faulty">Faulty</option>
                                <option value="Needs Repair">
                                  Needs Repair
                                </option>
                                <option value="Repaired">Repaired</option>
                                <option value="Leased">Leased</option>
                              </select>
                            </div>

                            <!-- Item Image -->
                            <div class="mb-3">
                              <label for="item_image" class="form-label"
                                >Item Image</label
                              >
                              <input
                                type="file"
                                class="form-control"
                                id="item_image"
                                name="item_image"
                                accept="image/*"
                              />
                              <img
                                id="image_preview"
                                src="#"
                                alt="Image Preview"
                                class="img-fluid mt-2"
                                style="display: none; max-width: 100%"
                              />
                            </div>
                          </div>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Close
                      </button>
                      <button
                        type="button"
                        class="btn btn-primary"
                        id="saveItem"
                      >
                        Save Item
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="panel-body">
                <table
                  id="itemTable"
                  class="display table table-striped table-bordered"
                >
                  <tbody id="itemList">
                    <!-- Table rows will be inserted here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <a
        href="javascript:;"
        class="btn btn-icon btn-circle btn-theme btn-scroll-to-top"
        data-toggle="scroll-to-top"
        ><i class="fa fa-angle-up"></i
      ></a>
    </div>

    <!-- jQuery (Ensure it's loaded before other JavaScript libraries that depend on it) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- QRCode.js -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="../assets/plugins/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../assets/plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
    <script src="../assets/plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../assets/plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>

    <script>
      $(document).ready(function () {
        function fetchItems() {
          $.ajax({
            url: "get_items.php",
            type: "GET",
            dataType: "json",
            success: function (response) {
              console.log("Response received:", response);
              try {
                if (response.status === "success") {
                  const items = response.items;
                  let tableRows = "";

                  // Initialize badge colors
                  const categoryBadgeColors = {
                    VIDEO: "#10538e",
                    IT: "#5C5470",
                    SOUND: "#03C988",
                    SIS: "#17a2b8",
                    LIGHTS: "#D36B00",
                    OTHER: "#6c757d",
                  };
                  const statusBadgeColors = {
                    New: "#262A56",
                    Working: "#42855B",
                    Faulty: "#461111",
                    "Needs Repair": "#C69749",
                    Repaired: "#577BC1",
                    Leased: "#6c757d",
                  };

                  if (Array.isArray(items) && items.length > 0) {
                    items.forEach(function (item) {
                      const imageSrc = item.item_image
                        ? "uploads/" + item.item_image
                        : "uploads/3.jpg";

                      tableRows += `
                  <tr>
                    <td>${item.id}</td>
                    <td><img src="${imageSrc}" alt="Image" width="40" class="img-thumbnail"></td>
                    <td>${item.item_name}</td>
                    <td>${item.item_description}</td>
                    <td><span class="badge" style="background-color: ${
                      categoryBadgeColors[item.item_category] || "#6c757d"
                    };">${item.item_category}</span></td>
                    <td>${item.serial_number}</td>
                    <td><div class="qrcode" data-serial="${
                      item.serial_number
                    }"></div></td>
                    <td><span class="badge" style="background-color: ${
                      statusBadgeColors[item.item_status] || "#6c757d"
                    };">${item.item_status}</span></td>
                    <td>${item.stock_location}</td>
                    <td>${item.date_added}</td>
                    <td>
                      <button class="btn btn-primary btn-sm edit-item-btn" data-item-id="${
                        item.id
                      }" data-bs-toggle="modal" data-bs-target="#editItemModal">
                        <i class="fa fa-pencil"></i>
                      </button>
                      <button class="btn btn-success btn-sm lease-item-btn" data-item-id="${
                        item.id
                      }" data-item-name="${
                        item.item_name
                      }" data-item-category="${
                        item.item_category
                      }" data-bs-toggle="modal" data-bs-target="#leaseItemModal">
                        <i class="fa fa-share"></i>
                      </button>
                    </td>
                  </tr>`;
                    });

                    // Reinitialize DataTable if there are rows
                    if (
                      $.fn.DataTable &&
                      $.fn.DataTable.isDataTable("#itemTable")
                    ) {
                      $("#itemTable").DataTable().clear().destroy();
                    }

                    // Insert the rows
                    $("#itemList").html(tableRows);

                    // Initialize QR Codes
                    $(".qrcode").each(function () {
                      const serialNumber = $(this).data("serial");
                      $(this).qrcode({ text: serialNumber });
                    });

                    // Initialize DataTable
                    $("#itemTable").DataTable({
                      responsive: true,
                      paging: true,
                      searching: true,
                      info: true,
                      dom: "Bfrtip",
                      buttons: ["copy", "excel", "pdf", "print"],
                    });
                  } else {
                    $("#itemList").html("<p>No items found.</p>");
                  }
                } else {
                  showAlert(
                    "error",
                    "Failed to load items. Please try again later."
                  );
                }
              } catch (e) {
                console.error("Error processing the response:", e);
                $("#itemList").html(
                  "<p>An error occurred while loading the items.</p>"
                );
              }
            },
            error: function (xhr, status, error) {
              console.error("Error fetching items:", xhr.status, error);
              $("#itemList").html(
                "<p>Error fetching items. Please try again later.</p>"
              );
            },
          });
        }

        function showAlert(icon, text) {
          Swal.fire({
            icon: icon,
            title: icon === "success" ? "Success" : "Error",
            text: text,
            toast: true,
            position: "top-right",
            showConfirmButton: false,
            timer: 3000,
          });
        }

        // Fetch items on page load
        fetchItems();

        // Preview image
        $("#item_image").on("change", function () {
          const [file] = this.files;
          if (file) {
            $("#image_preview").attr("src", URL.createObjectURL(file)).show();
          } else {
            $("#image_preview").hide();
          }
        });

        // Handle form submission
        $("#saveItem").on("click", function (e) {
          e.preventDefault();

          const itemName = $("#item_name").val().trim();
          const itemCategory = $("#item_category").val();
          const stockLocation = $("#stock_location").val();
          const itemStatus = $("#item_status").val();
          const serialNumber = $("#serial_number").val().trim();

          if (
            !itemName ||
            !itemCategory ||
            !stockLocation ||
            !itemStatus ||
            !serialNumber
          ) {
            showAlert("error", "Please fill in all required fields.");
            return;
          }

          const formData = new FormData($("#itemForm")[0]);

          $.ajax({
            url: "add_item.php",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            dataType: "json",
            success: function (response) {
              if (response.status === "success") {
                showAlert("success", response.message);
                fetchItems(); // Refresh the item list after a successful addition
              } else {
                showAlert("error", response.message);
              }
            },
            error: function (xhr, status, error) {
              console.error("AJAX Error:", status, error, xhr.responseText);
              showAlert("error", "An unexpected error occurred.");
            },
          });
        });
      });
    </script>
  </body>
</html>
