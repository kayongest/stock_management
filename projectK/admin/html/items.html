<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>:: ITEMS</title>
    <link rel="shortcut icon" href="../assets/img/app-store.png" />
    <meta
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
      name="viewport"
    />

    <meta name="description" content="Event Management Platform" />
    <meta name="author" content="Kayonga Raul" />

    <!-- Vendor CSS -->
    <link href="../assets/css/vendor.min.css" rel="stylesheet" />
    <link href="../assets/css/default/app.min.css" rel="stylesheet" />

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- DataTables CSS -->
    <link
      href="../assets/plugins/datatables.net-bs5/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="../assets/plugins/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css"
      rel="stylesheet"
    />

    <!-- Qr code script -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"
      integrity="sha512-k/KAe4Yff9EUdYI5/IAHlwUswqeipP+Cp5qnrsUjTPCgl51La2/JhyyjNciztD7mWNKLSXci48m7cctATKfLlQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <style>
      /* Google Fonts  */
      @import url("https://fonts.googleapis.com/css2?family=Titillium+Web:wght@200;300;400;600;700&display=swap");
      * {
        font-family: "Titillium Web", sans-serif;
      }
      .app-header {
        background-color: #35374b;
      }

      /* Ensure no global styles are applied */
      body {
        filter: none !important;
        backdrop-filter: none !important;
      }
    </style>
  </head>

  <body>
    <div id="loader" class="app-loader">
      <span class="spinner"></span>
    </div>

    <div id="app" class="app app-header-fixed app-sidebar-fixed">
      <div id="header" class="app-header text-white">
        <div class="navbar-header">
          <a href="index.html" class="navbar-brand text-white">
            <b class="me-3px">[aB]</b>ility</a
          >
          <button
            type="button"
            class="navbar-mobile-toggler"
            data-toggle="app-sidebar-mobile"
          >
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <div class="navbar-nav">
          <div class="navbar-item dropdown">
            <a
              href="#"
              data-bs-toggle="dropdown"
              class="navbar-link dropdown-toggle icon"
            >
              <i class="fa fa-bell text-white"></i>
              <span class="badge">5</span>
            </a>
            <div class="dropdown-menu media-list dropdown-menu-end">
              <div
                class="dropdown-header text-white"
                style="background-color: #044a42"
              >
                NOTIFICATIONS (5)
              </div>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <i class="fa fa-bug media-object bg-gray-500"></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">
                    Server Error Reports
                    <i class="fa fa-exclamation-circle text-danger"></i>
                  </h6>
                  <div class="text-muted fs-10px">3 minutes ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <img
                    src="../assets/img/user/user-1.jpg"
                    class="media-object"
                    alt
                  />
                  <i
                    class="fab fa-facebook-messenger text-blue media-object-icon"
                  ></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">John Smith</h6>
                  <p>
                    Quisque pulvinar tellus sit amet sem scelerisque tincidunt.
                  </p>
                  <div class="text-muted fs-10px">25 minutes ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <img
                    src="../assets/img/user/user-2.jpg"
                    class="media-object"
                    alt
                  />
                  <i
                    class="fab fa-facebook-messenger text-blue media-object-icon"
                  ></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">Olivia</h6>
                  <p>
                    Quisque pulvinar tellus sit amet sem scelerisque tincidunt.
                  </p>
                  <div class="text-muted fs-10px">35 minutes ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <i class="fa fa-plus media-object bg-gray-500"></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">New User Registered</h6>
                  <div class="text-muted fs-10px">1 hour ago</div>
                </div>
              </a>
              <a href="javascript:;" class="dropdown-item media">
                <div class="media-left">
                  <i class="fa fa-envelope media-object bg-gray-500"></i>
                  <i
                    class="fab fa-google text-warning media-object-icon fs-14px"
                  ></i>
                </div>
                <div class="media-body">
                  <h6 class="media-heading">New Email From John</h6>
                  <div class="text-muted fs-10px">2 hour ago</div>
                </div>
              </a>
              <div class="dropdown-footer text-center">
                <a href="javascript:;" class="text-decoration-none"
                  >View more</a
                >
              </div>
            </div>
          </div>
          <div class="navbar-item navbar-user dropdown text-white">
            <a
              href="#"
              class="navbar-link dropdown-toggle d-flex align-items-center"
              data-bs-toggle="dropdown"
            >
              <img
                src="<?php echo isset($_SESSION['photo']) ? $_SESSION['photo'] : '../assets/img/user/default-user.jpg'; ?>"
                alt="User Image"
              />
              <span>
                <span class="d-none d-md-inline text-white"
                  ><?php echo isset($_SESSION['full_name']) ? $_SESSION['full_name'] : 'Guest'; ?></span
                >
              </span>
            </a>
            <div class="dropdown-menu dropdown-menu-end me-1">
              <a href="extra_profile.html" class="dropdown-item"
                >Edit Profile</a
              >
              <a
                href="email_inbox.html"
                class="dropdown-item d-flex align-items-center"
              >
                Inbox
                <span class="badge bg-danger rounded-pill ms-auto pb-4px"
                  >2</span
                >
              </a>
              <a href="calendar.html" class="dropdown-item">Calendar</a>
              <a href="extra_settings_page.html" class="dropdown-item"
                >Settings</a
              >
              <div class="dropdown-divider"></div>
              <a href="login.html" class="dropdown-item">Log Out</a>
            </div>
          </div>
        </div>
      </div>

      <div id="sidebar" class="app-sidebar" data-bs-theme="dark">
        <div
          class="app-sidebar-content"
          data-scrollbar="true"
          data-height="100%"
        >
          <div class="menu">
            <div class="menu-profile">
              <div class="menu-profile-cover with-shadow"></div>
              <div class="menu-profile-image">
                <img src="../assets/img/user/user-13.jpg" alt />
              </div>
              <div class="menu-profile-info">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">Kayonga Raul</div>
                </div>
                <small>Administrator</small>
              </div>
            </div>
            <div class="menu-header">Navigation</div>
            <div class="menu-item active">
              <a href="items.php" class="menu-link">
                <div class="menu-icon">
                  <i class="fa fa-boxes-packing"></i>
                </div>
                <div class="menu-text">Dashboard</div>
              </a>
            </div>
            <div class="menu-item">
              <a href="stocks.html" class="menu-link">
                <div class="menu-icon">
                  <i class="fa fa-warehouse"></i>
                </div>
                <div class="menu-text">Stocks</div>
              </a>
            </div>
            <div class="menu-item">
              <a href="scan.php" class="menu-link">
                <div class="menu-icon">
                  <i class="fa fa-qrcode"></i>
                </div>
                <div class="menu-text">Scan</div>
              </a>
            </div>
            <div class="menu-item">
              <a href="users.php" class="menu-link">
                <div class="menu-icon">
                  <i class="fa fa-users"></i>
                </div>
                <div class="menu-text">Users</div>
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="app-sidebar-bg" data-bs-theme="dark"></div>
      <div class="app-sidebar-mobile-backdrop">
        <a
          href="#"
          data-dismiss="app-sidebar-mobile"
          class="stretched-link"
        ></a>
      </div>

      <div id="content" class="app-content">
        <h1 class="page-header">
          Dashboard <small>overall statistics ..</small>
        </h1>

        <div class="row">
          <div class="col-lg-3">
            <div
              class="widget widget-stats bg-"
              style="background-color: #535c91"
            >
              <div class="stats-icon">
                <i class="fa fa-users-gear"></i>
                <img src="" alt="" />
              </div>
              <div class="stats-info">
                <h4>TECHNICIANS</h4>
                <p>15</p>
              </div>
              <div class="stats-link">
                <a href="javascript:;">View Detail </a>
              </div>
            </div>
          </div>

          <div class="col-lg-3">
            <div
              class="widget widget-stats bg-"
              style="background-color: #474e68"
            >
              <div class="stats-icon"><i class="fa fa-user-friends"></i></div>
              <div class="stats-info">
                <h4>USERS</h4>
                <p>6</p>
              </div>
              <div class="stats-link">
                <a href="javascript:;"
                  >View Detail
                  <!-- <i class="fa fa-arrow-alt-circle-right"></i> -->
                </a>
              </div>
            </div>
          </div>

          <div class="col-lg-3">
            <div
              class="widget widget-stats bg-"
              style="background-color: #2f576e"
            >
              <div class="stats-icon"><i class="fa fa-warehouse"></i></div>
              <div class="stats-info">
                <h4>STOCKS</h4>
                <p>5</p>
              </div>
              <div class="stats-link">
                <a href="javascript:;"
                  >View Detail
                  <!-- <i class="fa fa-arrow-alt-circle-right"></i> -->
                </a>
              </div>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="widget widget-stats bg-" style="background: #3a9188">
              <div class="stats-icon"><i class="fa fa-tools"></i></div>
              <div class="stats-info">
                <h4>EQUIPMENTS</h4>
                <p><span class="equipments">0</span></p>
              </div>
              <div class="stats-link">
                <a href="javascript:;"
                  >View Detail
                  <!-- <i class="fa fa-arrow-alt-circle-right"></i> -->
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- <div class="row">
          <div class="col-lg-3">
            <div
              class="widget widget-stats bg-"
              style="background-color: #b95b0a"
            >
              <div class="stats-icon">
                <i class="fa fa-exclamation-circle"></i>
                <img src="" alt="" />
              </div>
              <div class="stats-info">
                <h4>PENDING REQUESTS</h4>
                <p>15</p>
              </div>
              <div class="stats-link">
                <a href="javascript:;">View Detail </a>
              </div>
            </div>
          </div>
        </div> -->

        <div class="row">
          <div class="col-xl-12">
            <div class="panel panel-inverse">
              <div class="panel-heading">
                <h4 class="panel-title">ITEMS</h4>
                <div class="panel-heading-btn">
                  <a
                    href="javascript:;"
                    class="btn btn-xs btn-icon btn-success"
                    data-toggle="panel-reload"
                    ><i class="fa fa-redo"></i
                  ></a>
                  <a
                    href="javascript:;"
                    class="btn btn-xs btn-icon btn-warning"
                    data-toggle="panel-collapse"
                    ><i class="fa fa-minus"></i
                  ></a>
                </div>
              </div>

              <div class="panel-footer">
                <div class="container">
                  <div class="row">
                    <div class="col-sm-6">
                      <a
                        href="#modal-dialog"
                        class="btn btn-md me-1 text-white"
                        style="background-color: #0b6b94"
                        data-bs-toggle="modal"
                        data-bs-target="#itemModal"
                        >ADD</a
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modal -->
              <div
                class="modal fade"
                id="itemModal"
                tabindex="-1"
                aria-labelledby="itemModalLabel"
                aria-hidden="true"
              >
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header" style="background-color: #20425f">
                      <h4 class="modal-title text-white" id="itemModalLabel">
                        ADD ITEM
                      </h4>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      ></button>
                    </div>
                    <div class="modal-body">
                      <form id="itemForm" enctype="multipart/form-data">
                        <!-- Hidden Input for Item ID -->
                        <input type="hidden" id="item_id" name="item_id" />

                        <!-- Grid System for Two Columns -->
                        <div class="row">
                          <!-- Column 1 -->
                          <div class="col-md-6">
                            <!-- Item Name -->
                            <div class="mb-3">
                              <label for="item_name" class="form-label"
                                >Item Name</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="item_name"
                                name="item_name"
                                required
                              />
                            </div>

                            <!-- Item Description -->
                            <div class="mb-3">
                              <label for="item_description" class="form-label"
                                >Item Description</label
                              >
                              <textarea
                                class="form-control"
                                id="item_description"
                                name="item_description"
                              ></textarea>
                            </div>

                            <!-- Item Category -->
                            <div class="mb-3">
                              <label for="item_category" class="form-label"
                                >Item Category</label
                              >
                              <select
                                class="form-select"
                                id="item_category"
                                name="item_category"
                                required
                              >
                                <option value="">-- select --</option>
                                <option value="VIDEO">VIDEO</option>
                                <option value="IT">IT</option>
                                <option value="SOUND">SOUND</option>
                                <option value="SIS">SIS</option>
                                <option value="LIGHTS">LIGHTS</option>
                                <option value="OTHER">OTHER</option>
                              </select>
                            </div>

                            <!-- Stock Location -->
                            <div class="mb-3">
                              <label for="stock_location" class="form-label"
                                >Stock Location</label
                              >
                              <select
                                class="form-select"
                                id="stock_location"
                                name="stock_location"
                                required
                              >
                                <option value="">-- select --</option>
                                <option value="Masoro">Masoro</option>
                                <option value="KCC">KCC</option>
                                <option value="BK Arena">BK Arena</option>
                                <option value="Ndera">Ndera</option>
                                <option value="Rugando">Rugando</option>
                              </select>
                            </div>

                            <!-- Serial Number -->
                            <div class="mb-3">
                              <label for="serial_number" class="form-label"
                                >Serial Number</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="serial_number"
                                name="serial_number"
                                required
                              />
                            </div>
                          </div>

                          <!-- Column 2 -->
                          <div class="col-md-6">
                            <!-- Item Status -->
                            <div class="mb-3">
                              <label for="item_status" class="form-label"
                                >Item Status</label
                              >
                              <select
                                class="form-select"
                                id="item_status"
                                name="item_status"
                                required
                              >
                                <option value="">-- select --</option>
                                <option value="Working">Working</option>
                                <option value="Faulty">Faulty</option>
                                <option value="Needs Repair">
                                  Needs Repair
                                </option>
                                <option value="Repaired">Repaired</option>
                                <option value="Leased">Leased</option>
                              </select>
                            </div>
                            <!-- Existing or New Item Switch -->
                            <div class="mb-2">
                              <div
                                class="d-flex justify-content-between align-items-center"
                              >
                                <!-- Label and Switch Group -->
                                <div class="d-flex flex-column">
                                  <!-- Label on top -->
                                  <label
                                    for="itemTypeSwitch"
                                    class="form-label md-0"
                                    id="itemTypeLabel"
                                  >
                                    Item State:
                                  </label>
                                  <!-- Switch below the label -->
                                  <div class="form-check form-switch">
                                    <input
                                      class="form-check-input"
                                      type="checkbox"
                                      id="itemTypeSwitch"
                                      name="item_type"
                                      value="New"
                                      onchange="toggleItemType()"
                                    />
                                    <!-- Hidden input to handle the unchecked case -->
                                    <input
                                      type="hidden"
                                      name="item_type"
                                      value="Existing"
                                    />
                                  </div>
                                </div>

                                <!-- Pill on the right -->
                                <div
                                  id="itemStatePill"
                                  class="btn btn-xs btn-dark mt-2"
                                >
                                  Existing
                                </div>
                              </div>
                            </div>

                            <script>
                              function toggleItemType() {
                                const switchInput =
                                  document.getElementById("itemTypeSwitch");
                                const itemStatePill =
                                  document.getElementById("itemStatePill");

                                // Change pill text and color based on the switch state
                                if (switchInput.checked) {
                                  itemStatePill.innerText = "New";
                                  itemStatePill.className =
                                    "btn btn-xs btn-success ms-2"; // Green for new
                                } else {
                                  itemStatePill.innerText = "Existing";
                                  itemStatePill.className =
                                    "btn btn-xs btn-dark ms-2"; // Gray for existing
                                }
                              }
                            </script>

                            <!-- Item Image -->
                            <div class="mb-3">
                              <label for="item_image" class="form-label"
                                >Item Image</label
                              >
                              <input
                                type="file"
                                class="form-control"
                                id="item_image"
                                name="item_image"
                                accept="image/*"
                              />
                              <img
                                id="image_preview"
                                src="#"
                                alt="Image Preview"
                                class="img-fluid mt-2"
                                style="display: none; max-width: 100%"
                              />
                            </div>
                          </div>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Close
                      </button>
                      <button
                        type="button"
                        class="btn btn-primary"
                        id="saveItem"
                      >
                        Save Item
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="panel-body">
                <table
                  id="itemTable"
                  class="display table table-striped table-bordered"
                >
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Image</th>
                      <th>Name</th>
                      <th>Description</th>
                      <th>Category</th>
                      <th>Serial Number</th>
                      <th>Status</th>
                      <th>Stock Location</th>
                      <th>Created Date</th>
                      <th>Item Type</th>
                      <th>Qr Code</th>
                      <th>Item Type</th>
                    </tr>
                  </thead>
                  <tbody id="itemList">
                    <!-- Table rows will be inserted here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <a
        href="javascript:;"
        class="btn btn-icon btn-circle btn-theme btn-scroll-to-top"
        data-toggle="scroll-to-top"
        ><i class="fa fa-angle-up"></i
      ></a>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <!-- Your custom scripts -->
    <script>
      $(document).ready(function () {
        function fetchItems() {
          $.ajax({
            url: "get_items.php",
            type: "GET",
            dataType: "json",
            success: function (response) {
              console.log("Response received:", response); // For debugging

              try {
                if (response.status === "success") {
                  let items = response.items;

                  // Update the equipment count
                  const equipmentCount = Array.isArray(items)
                    ? items.length
                    : 0;
                  $(".equipments").text(equipmentCount); // Update the count

                  // Define category and status colors
                  const categoryBadgeColors = {
                    VIDEO: "#10538e",
                    IT: "#5C5470",
                    SOUND: "#03C988",
                    SIS: "#17a2b8",
                    LIGHTS: "#D36B00",
                    OTHER: "#6c757d",
                  };

                  const statusBadgeColors = {
                    New: "#262A56",
                    Working: "#42855B",
                    Faulty: "#461111",
                    "Needs Repair": "#C69749",
                    Repaired: "#577BC1",
                    Leased: "#6c757d",
                  };

                  // Prepare the data for DataTables
                  let tableData = items.map(function (item) {
                    // Determine the button class based on item type
                    const buttonClass =
                      item.item_type === "success"
                        ? "btn-outline-success"
                        : "btn-outline-secondary";

                    return {
                      id: item.id,
                      item_image: `<img src="uploads/${
                        item.item_image || "3.jpg"
                      }" alt="Image" width="40" class="img-thumbnail">`,
                      item_name: item.item_name,
                      item_description: item.item_description,
                      item_category: `<span class="badge" style="background-color: ${
                        categoryBadgeColors[item.item_category] || "#6c757d"
                      };">${item.item_category}</span>`,
                      serial_number: item.serial_number,
                      item_status: `<span class="badge" style="background-color: ${
                        statusBadgeColors[item.item_status] || "#6c757d"
                      };">${item.item_status}</span>`,
                      stock_location: item.stock_location,
                      date_added: item.date_added,
                      item_type: `<button class="btn btn-sm ${buttonClass}">${item.item_type}</button>`, // Display item type as a button
                      qr_code_url: `<img src="${item.qr_code_url}" alt="QR Code" width="50" class="img-thumbnail">`,
                      actions: `<button class="btn btn-primary btn-sm edit-item-btn" data-item-id="${item.id}" data-bs-toggle="modal" data-bs-target="#editItemModal"><i class="fa fa-pencil"></i></button>
                        <button class="btn btn-success btn-sm lease-item-btn" data-item-id="${item.id}" data-item-name="${item.item_name}" data-item-category="${item.item_category}" data-bs-toggle="modal" data-bs-target="#leaseItemModal"><i class="fa fa-share"></i></button>`,
                    };
                  });

                  // Update the DataTable
                  if ($.fn.DataTable.isDataTable("#itemTable")) {
                    const table = $("#itemTable").DataTable();
                    table.clear().rows.add(tableData).draw(); // Use tableData directly
                  } else {
                    $("#itemList").html(
                      '<table id="itemTable" class="display table table-striped table-bordered">' +
                        "<thead><tr><th>ID</th><th>Image</th><th>Name</th><th>Description</th><th>Category</th><th>Serial Number</th><th>Status</th><th>Stock Location</th><th>Created Date</th><th>Item Type</th><th>QR Code</th><th>Action</th></tr></thead><tbody></tbody></table>"
                    );

                    $("#itemTable").DataTable({
                      data: tableData, // Use tableData to populate
                      columns: [
                        { data: "id" },
                        { data: "item_image" },
                        { data: "item_name" },
                        { data: "item_description" },
                        { data: "item_category" },
                        { data: "serial_number" },
                        { data: "item_status" },
                        { data: "stock_location" },
                        { data: "date_added" },
                        { data: "item_type" }, // Item type as a button
                        { data: "qr_code_url" },
                        { data: "actions" },
                      ],
                      responsive: true,
                      paging: true,
                      searching: true,
                      info: true,
                      dom: "Bfrtip",
                      buttons: ["copy", "excel", "pdf", "print"],
                    });
                  }
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Failed to load items. Please try again later.",
                    timer: 3000,
                    showConfirmButton: false,
                  });
                }
              } catch (e) {
                console.error("Error processing the response:", e);
                $("#itemList").html(
                  "<p>An error occurred while loading the items.</p>"
                );
              }
            },
            error: function (xhr, status, error) {
              console.error("Error fetching items:", error);
              $("#itemList").html(
                "<p>Error fetching items. Please try again later.</p>"
              );
            },
          });
        }

        fetchItems();

        // Preview the image when selected
        $("#item_image").on("change", function () {
          const [file] = this.files;
          if (file) {
            $("#image_preview").attr("src", URL.createObjectURL(file)).show();
          } else {
            $("#image_preview").hide();
          }
        });

        // Handle form submission
        $("#saveItem").on("click", function (e) {
          e.preventDefault();

          const itemName = $("#item_name").val().trim();
          const itemCategory = $("#item_category").val();
          const stockLocation = $("#stock_location").val();
          const itemStatus = $("#item_status").val();
          const serialNumber = $("#serial_number").val().trim();
          const itemType = $("#itemTypeSwitch").is(":checked")
            ? "New"
            : "Existing";

          // Validate required fields
          if (
            !itemName ||
            !itemCategory ||
            !stockLocation ||
            !itemStatus ||
            !serialNumber
          ) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Please fill in all required fields.",
              toast: true,
              position: "top-right",
              showConfirmButton: false,
              timer: 3000,
            });
            return;
          }

          // Create a FormData object from the form
          const formData = new FormData($("#itemForm")[0]);
          formData.append("item_type", itemType);

          // AJAX request to save item
          $.ajax({
            url: "add_item.php",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            dataType: "json",
            success: function (response) {
              if (response.status === "success") {
                const qrCodeData = {
                  "Item ID": response.item_id,
                  "Item Name": itemName,
                  Description: $("#item_description").val().trim(),
                  Category: itemCategory,
                  "Serial Number": serialNumber,
                  Location: stockLocation,
                  Status: itemStatus,
                  item_type: itemType,
                };

                const qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(
                  JSON.stringify(qrCodeData)
                )}`;
                console.log("Generated QR Code URL:", qrCodeUrl); // For debugging

                fetchItems(); // Refresh the item list to include new QR code

                Swal.fire({
                  icon: "success",
                  title: "Success",
                  text: response.message,
                  toast: true,
                  position: "top-right",
                  showConfirmButton: false,
                  timer: 3000,
                });
                $("#itemModal").modal("hide");
                $("#itemForm")[0].reset();
                $("#image_preview").hide();
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Error",
                  text: response.message,
                  toast: true,
                  position: "top-right",
                  showConfirmButton: false,
                  timer: 3000,
                });
              }
            },
            error: function (xhr, status, error) {
              console.error("AJAX Error:", status, error, xhr.responseText);
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "An unexpected error occurred.",
                toast: true,
                position: "top-right",
                showConfirmButton: false,
                timer: 3000,
              });
            },
          });
        }); // Ensure this closing brace is included
      });
    </script>

    <!-- Vendor and Plugin Scripts -->
    <script src="../assets/js/vendor.min.js"></script>
    <script src="../assets/js/app.min.js"></script>
    <script src="../assets/plugins/datatables.net/js/dataTables.min.js"></script>
    <script src="../assets/plugins/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
    <script src="../assets/plugins/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../assets/plugins/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>
    <script src="../assets/plugins/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../assets/plugins/datatables.net-buttons-bs5/js/buttons.bootstrap5.min.js"></script>
    <script src="../assets/plugins/datatables.net-buttons/js/buttons.colVis.min.js"></script>
    <script src="../assets/plugins/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../assets/plugins/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../assets/plugins/pdfmake/build/vfs_fonts.js"></script>
    <script src="../assets/plugins/jszip/dist/jszip.min.js"></script>
    <script src="../assets/js/demo/table-manage-buttons.demo.js"></script>
    <script src="../assets/plugins/%40highlightjs/cdn-assets/highlight.min.js"></script>
    <script src="../assets/js/demo/render.highlight.js"></script>
  </body>
</html>
